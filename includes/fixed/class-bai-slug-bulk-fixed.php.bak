<?php
if ( ! defined( 'ABSPATH' ) ) { exit; }

class BAI_Slug_Bulk_Fixed {
    public function __construct() {
        add_action( 'admin_menu', [ $this, 'add_menu' ] );
        add_action( 'admin_enqueue_scripts', [ $this, 'enqueue' ] );
        add_action( 'wp_ajax_bai_slug_batch', [ $this, 'ajax_batch' ] );
    }

    public function add_menu() {
        add_submenu_page(
            'options-general.php',
            BAI_Slug_I18n::t('bulk_title'),
            BAI_Slug_I18n::t('bulk_title'),
            'manage_options',
            'bai-slug-bulk',
            [ $this, 'render' ]
        );
    }

    public function enqueue( $hook ) {
        if ( $hook !== 'settings_page_bai-slug-bulk' ) return;
        wp_enqueue_style( 'bai-slug-admin', BAI_SLUG_URL . 'assets/admin.css', [], BAI_SLUG_VERSION );
        wp_enqueue_script( 'bai-slug-bulk', BAI_SLUG_URL . 'assets/bulk.js', [ 'jquery' ], BAI_SLUG_VERSION, true );
        wp_localize_script( 'bai-slug-bulk', 'BAISlugBulk', [
            'ajax_url' => admin_url( 'admin-ajax.php' ),
            'nonce'    => wp_create_nonce( 'bai_slug_bulk' ),
            'i18n'     => [
                'request_failed' => ( BAI_Slug_I18n::lang() === 'en' ? 'Request failed' : 'è¯·æ±‚å¤±è´¥' ),
                'done' => ( BAI_Slug_I18n::lang() === 'en' ? 'Done' : 'ä»»åŠ¡å®Œæˆ' ),
                'network_error' => ( BAI_Slug_I18n::lang() === 'en' ? 'Network error' : 'ç½‘ç»œé”™è¯¯' ),
                'cursor_reset' => ( BAI_Slug_I18n::lang() === 'en' ? 'Cursor reset' : 'æ¸¸æ ‡å·²é‡ç½? ),
            ],
        ] );
    }

    public function render() {
        if ( ! current_user_can( 'manage_options' ) ) return;
        $settings = BAI_Slug_Settings::get_settings();
        $pts = get_post_types( [ 'show_ui' => true ], 'objects' );
        $cursor = (int) get_option( 'bai_slug_bulk_cursor', 0 );
        ?>
        <div class="wrap bai-slug-bulk">
            <h1><?php echo esc_html( BAI_Slug_I18n::t('bulk_title') ); ?></h1>
            <div class="notice notice-info"><p><?php echo esc_html( BAI_Slug_I18n::t('bulk_notice') ); ?></p></div>
            <p><?php echo esc_html( BAI_Slug_I18n::t('bulk_desc') ); ?></p>

            <div class="card">
                <h2><?php echo esc_html__( 'ä»»åŠ¡é…ç½®', 'wp-ai-slug' ); ?></h2>
                <table class="form-table">
                    <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_post_types') ); ?></th><td>
                        <?php foreach ( $pts as $pt => $obj ) : ?>
                            <label style="display:inline-block;margin-right:12px;">
                                <input type="checkbox" class="bai-pt" value="<?php echo esc_attr( $pt ); ?>" <?php checked( in_array( $pt, (array) $settings['enabled_post_types'], true ) ); ?> />
                                <?php echo esc_html( $obj->labels->singular_name ); ?>
                            </label>
                        <?php endforeach; ?>
                    </td></tr>
                    <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_batch_size') ); ?></th><td>
                        <input type="number" id="bai-batch-size" min="1" max="50" value="5" />
                        <p class="description">5â€?0 å»ºè®®ã€?/p>
                    </td></tr>
                    <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_filters') ); ?></th><td>
                        <label><input type="checkbox" id="bai-only-non-ascii" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_only_non_ascii') ); ?></label><br>
                        <label><input type="checkbox" id="bai-only-eq-sanitized" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_only_eq_sanitized') ); ?></label><br>
                        <label><input type="checkbox" id="bai-skip-user-edited" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_skip_user') ); ?></label>
                    </td></tr>
                </table>
                <p>
                    <button class="button button-primary" id="bai-start"><?php echo esc_html( BAI_Slug_I18n::t('btn_start') ); ?></button>
                    <button class="button" id="bai-stop" disabled><?php echo esc_html( BAI_Slug_I18n::t('btn_stop') ); ?></button>
                    <button class="button" id="bai-reset"><?php echo esc_html( BAI_Slug_I18n::t('btn_reset_cursor') ); ?></button>
                </p>
                <p class="description"><?php echo esc_html( BAI_Slug_I18n::t('cursor') ); ?><code id="bai-cursor"><?php echo (int) $cursor; ?></code></p>
            </div>

            <div class="card">
                <h2><?php echo esc_html__( 'è¿›åº¦', 'wp-ai-slug' ); ?></h2>
                <p><?php printf( esc_html( BAI_Slug_I18n::t('progress') ), '<strong id="bai-processed">0</strong>', '<strong id="bai-scanned">0</strong>' ); ?></p>
                <div id="bai-log" class="bgi-log"></div>
            </div>
        </div>
        <?php
    }

    private function has_non_ascii( $str ) { return (bool) preg_match( '/[^\x00-\x7F]/', (string) $str ); }

    public function ajax_batch() {
        if ( ! current_user_can( 'manage_options' ) ) wp_send_json_error( [ 'message' => 'denied' ], 403 );
        check_ajax_referer( 'bai_slug_bulk', 'nonce' );

        $batch_size = max( 1, min( 50, intval( $_POST['batch_size'] ?? 10 ) ) );
        $cursor     = max( 0, intval( $_POST['cursor'] ?? get_option( 'bai_slug_bulk_cursor', 0 ) ) );
        $post_types = isset( $_POST['post_types'] ) && is_array( $_POST['post_types'] ) ? array_map( 'sanitize_text_field', wp_unslash( $_POST['post_types'] ) ) : [];
        $only_non_ascii      = ! empty( $_POST['only_non_ascii'] );
        $only_eq_sanitized   = ! empty( $_POST['only_equal_sanitized'] );
        $skip_user_edited    = ! empty( $_POST['skip_user_edited'] );
        $reset_cursor        = ! empty( $_POST['reset_cursor'] );

        if ( $reset_cursor ) { $cursor = 0; }

        // å¦‚æžœæœªæ˜¾å¼å‹¾é€‰ï¼Œå›žé€€åˆ°è®¾ç½®ä¸­å¯ç”¨çš„æ–‡ç« ç±»åž?        if ( empty( $post_types ) ) {
            $settings = BAI_Slug_Settings::get_settings();
            $post_types = (array) ( $settings['enabled_post_types'] ?? [] );
        }
        if ( empty( $post_types ) ) {
            wp_send_json_error( [ 'message' => 'è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ–‡ç« ç±»åž? ], 400 );
        }

        global $wpdb;
        $statuses = [ 'publish', 'future', 'draft', 'pending', 'private' ];
        $scan_limit = 100;

        $pt_placeholders = implode( ', ', array_fill( 0, count( $post_types ), '%s' ) );
        $st_placeholders = implode( ', ', array_fill( 0, count( $statuses ), '%s' ) );

        // ç»„è£… SQL å¹¶æ•èŽ·æ½œåœ¨é”™è¯?        $prepared_args = array_merge( $statuses, $post_types, [ (int) $cursor, (int) $scan_limit ] );
        $sql = $wpdb->prepare(
            "SELECT ID, post_title, post_name, post_type FROM {$wpdb->posts}
             WHERE post_status IN ($st_placeholders)
               AND post_type IN ($pt_placeholders)
               AND ID > %d
             ORDER BY ID ASC
             LIMIT %d",
            $prepared_args
        );

        if ( empty( $sql ) ) {
            wp_send_json_error( [ 'message' => 'æŸ¥è¯¢æž„å»ºå¤±è´¥' ], 500 );
        }

        $rows = $wpdb->get_results( $sql );
        if ( $rows === null ) {
            $err = method_exists( $wpdb, 'last_error' ) ? $wpdb->last_error : '';
            wp_send_json_error( [ 'message' => 'æ•°æ®åº“æŸ¥è¯¢å¤±è´? . ( $err ? (': '.$err) : '' ) ] , 500 );
        }
        $processed = 0; $scanned = 0; $last = $cursor; $logs = [];
        foreach ( $rows as $row ) {
            $scanned++; $last = (int) $row->ID;
            if ( $skip_user_edited && get_post_meta( $row->ID, '_slug_source', true ) === 'user-edited' ) continue;

            $current_slug = (string) $row->post_name;
            $sanitized_title = sanitize_title( $row->post_title );
            if ( $only_non_ascii && $current_slug !== '' && ! $this->has_non_ascii( $current_slug ) ) continue;
            if ( $only_eq_sanitized && $current_slug !== '' && $current_slug !== $sanitized_title ) continue;

            $slug = BAI_Slug_Helpers::request_slug( $row->post_title, $settings );
            if ( $slug ) {
                $res = wp_update_post( [ 'ID' => $row->ID, 'post_name' => $slug ], true );
                if ( is_wp_error( $res ) ) {
                    if ( class_exists( 'BAI_Slug_Log' ) ) { BAI_Slug_Log::add( 'æ‰¹é‡æ›´æ–°å¤±è´¥ï¼? . $res->get_error_message(), $row->post_title ); }
                } else {
                    update_post_meta( $row->ID, '_generated_slug', $slug );
                    update_post_meta( $row->ID, '_slug_source', 'ai' );
                    BAI_Slug_Settings::increment_counter();
                    if ( class_exists( 'BAI_Slug_Log' ) ) { BAI_Slug_Log::add( 'æ‰¹é‡æ›´æ–°æˆåŠŸ: ' . $slug, $row->post_title ); }
                    $processed++;
                }
            } else {
                if ( class_exists( 'BAI_Slug_Log' ) ) { BAI_Slug_Log::add( 'æ‰¹é‡ç”Ÿæˆå¤±è´¥ï¼ˆæ— ç»“æžœï¼‰ã€?, $row->post_title ); }
            }
            if ( $processed >= $batch_size ) break;
        }

        update_option( 'bai_slug_bulk_cursor', (int) $last );
        $done = empty( $rows );
        wp_send_json_success( [ 'processed' => (int) $processed, 'scanned' => (int) $scanned, 'cursor' => (int) $last, 'done' => (bool) $done, 'log' => $logs ] );
    }

    // å†…åµŒåˆ°è®¾ç½®é¡µçš„æ¸²æŸ“ï¼ˆä¸åŒ…å«å¤–å±?wrapï¼‰ï¼Œç”¨äºŽ Tab é¢æ¿ç›´æŽ¥å±•ç¤º
    public function render_inner() {
        if ( ! current_user_can( 'manage_options' ) ) return;
        $settings = BAI_Slug_Settings::get_settings();
        $pts = get_post_types( [ 'show_ui' => true ], 'objects' );
        $cursor = (int) get_option( 'bai_slug_bulk_cursor', 0 );
        ?>
        <div class="card">
            <h2><?php echo esc_html__( 'ä»»åŠ¡é…ç½®', 'wp-ai-slug' ); ?></h2>
            <p class="description"><?php echo esc_html( BAI_Slug_I18n::t('bulk_notice') ); ?></p>
            <table class="form-table">
                <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_post_types') ); ?></th><td>
                    <?php foreach ( $pts as $pt => $obj ) : ?>
                        <label style="display:inline-block;margin-right:12px;">
                            <input type="checkbox" class="bai-pt" value="<?php echo esc_attr( $pt ); ?>" <?php checked( in_array( $pt, (array) $settings['enabled_post_types'], true ) ); ?> />
                            <?php echo esc_html( $obj->labels->singular_name ); ?>
                        </label>
                    <?php endforeach; ?>
                </td></tr>
                <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_batch_size') ); ?></th><td>
                    <input type="number" id="bai-batch-size" min="1" max="50" value="10" />
                    <p class="description">5â€?0 å»ºè®®ã€?/p>
                </td></tr>
                <tr><th><?php echo esc_html( BAI_Slug_I18n::t('label_filters') ); ?></th><td>
                    <label><input type="checkbox" id="bai-only-non-ascii" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_only_non_ascii') ); ?></label><br>
                    <label><input type="checkbox" id="bai-only-eq-sanitized" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_only_eq_sanitized') ); ?></label><br>
                    <label><input type="checkbox" id="bai-skip-user-edited" checked /> <?php echo esc_html( BAI_Slug_I18n::t('filter_skip_user') ); ?></label>
                </td></tr>
            </table>
            <p>
                <button class="button button-primary" id="bai-start"><?php echo esc_html( BAI_Slug_I18n::t('btn_start') ); ?></button>
                <button class="button" id="bai-stop" disabled><?php echo esc_html( BAI_Slug_I18n::t('btn_stop') ); ?></button>
                <button class="button" id="bai-reset"><?php echo esc_html( BAI_Slug_I18n::t('btn_reset_cursor') ); ?></button>
            </p>
            <p class="description"><?php echo esc_html( BAI_Slug_I18n::t('cursor') ); ?><code id="bai-cursor"><?php echo (int) $cursor; ?></code></p>
        </div>

        <div class="card">
            <h2><?php echo esc_html__( 'è¿›åº¦', 'wp-ai-slug' ); ?></h2>
            <p><?php printf( esc_html( BAI_Slug_I18n::t('progress') ), '<strong id="bai-processed">0</strong>', '<strong id="bai-scanned">0</strong>' ); ?></p>
            <div id="bai-log" class="bgi-log"></div>
        </div>
        <?php
    }
}
